From e2bfbdb94e30004169e9f2b12ed2e9323df15bd1 Mon Sep 17 00:00:00 2001
From: tobigun <hennymcc@yahoo.de>
Date: Sun, 14 Feb 2016 13:03:14 +0100
Subject: [PATCH] add support for ss222

Change-Id: Ic4cc232d3c2f19bba845f5def9997c267cb4419e
---
 ril/Android.mk                  |  2 +-
 ril/libril/Android.mk           |  3 +++
 ril/libril/ril.cpp              | 32 +++++++++++++++++++++++++-------
 ril/libsecril-client/Android.mk |  3 +++
 4 files changed, 32 insertions(+), 8 deletions(-)

diff --git a/ril/Android.mk b/ril/Android.mk
index de33c11..e8e6a77 100644
--- a/ril/Android.mk
+++ b/ril/Android.mk
@@ -20,7 +20,7 @@ ifeq ($(BOARD_VENDOR),samsung)
 
 # libril
 ifeq ($(BOARD_PROVIDES_LIBRIL),true)
-ifneq ($(filter xmm6260 xmm6262 xmm6360 xmm7260 m7450 ss333,$(BOARD_MODEM_TYPE)),)
+ifneq ($(filter xmm6260 xmm6262 xmm6360 xmm7260 m7450 ss222 ss333,$(BOARD_MODEM_TYPE)),)
 include $(RIL_PATH)/libril/Android.mk
 endif
 endif
diff --git a/ril/libril/Android.mk b/ril/libril/Android.mk
index f3d5545..23dd1d8 100644
--- a/ril/libril/Android.mk
+++ b/ril/libril/Android.mk
@@ -34,6 +34,9 @@ endif
 ifeq ($(BOARD_MODEM_TYPE),m7450)
 LOCAL_CFLAGS := -DMODEM_TYPE_M7450
 endif
+ifeq ($(BOARD_MODEM_TYPE),ss222)
+LOCAL_CFLAGS := -DMODEM_TYPE_SS222
+endif
 ifeq ($(BOARD_MODEM_TYPE),ss333)
 LOCAL_CFLAGS := -DMODEM_TYPE_SS333
 endif
diff --git a/ril/libril/ril.cpp b/ril/libril/ril.cpp
index beae829..49c1c35 100644
--- a/ril/libril/ril.cpp
+++ b/ril/libril/ril.cpp
@@ -173,6 +173,8 @@ static pthread_t s_tid_dispatch;
 static pthread_t s_tid_reader;
 static int s_started = 0;
 
+static int s_cpCrashed = 0;
+
 static int s_fdDebug = -1;
 static int s_fdDebug_socket2 = -1;
 
@@ -789,7 +791,7 @@ dispatchDial (Parcel &p, RequestInfo *pRI) {
     int32_t sizeOfDial;
     int32_t t;
     int32_t uusPresent;
-#if defined(MODEM_TYPE_XMM7260) || defined(MODEM_TYPE_M7450) || defined(MODEM_TYPE_SS333)
+#if defined(MODEM_TYPE_XMM7260) || defined(MODEM_TYPE_M7450) || defined(MODEM_TYPE_SS222) || defined(MODEM_TYPE_SS333)
     char *csv;
 #endif
     status_t status;
@@ -806,7 +808,7 @@ dispatchDial (Parcel &p, RequestInfo *pRI) {
         goto invalid;
     }
 
-#if defined(MODEM_TYPE_XMM7260) || defined(MODEM_TYPE_M7450) || defined(MODEM_TYPE_SS333)
+#if defined(MODEM_TYPE_XMM7260) || defined(MODEM_TYPE_M7450) || defined(MODEM_TYPE_SS222) || defined(MODEM_TYPE_SS333)
     /* CallDetails.call_type */
     status = p.readInt32(&t);
     if (status != NO_ERROR) {
@@ -837,7 +839,7 @@ dispatchDial (Parcel &p, RequestInfo *pRI) {
 
         if (uusPresent == 0) {
 #if defined(MODEM_TYPE_XMM6262) || defined(MODEM_TYPE_XMM7260) \
- || defined(MODEM_TYPE_M7450) || defined(MODEM_TYPE_SS333)
+ || defined(MODEM_TYPE_M7450) || defined(MODEM_TYPE_SS222) || defined(MODEM_TYPE_SS333)
             dial.uusInfo = NULL;
 #elif defined(MODEM_TYPE_XMM6260)
             /* Samsung hack */
@@ -2387,7 +2389,7 @@ static int responseCallList(Parcel &p, void *response, size_t responselen) {
         p.writeInt32(p_cur->als);
         p.writeInt32(p_cur->isVoice);
 
-#if defined(MODEM_TYPE_XMM7260) || defined(MODEM_TYPE_M7450) || defined(MODEM_TYPE_SS333)
+#if defined(MODEM_TYPE_XMM7260) || defined(MODEM_TYPE_M7450) || defined(MODEM_TYPE_SS222) || defined(MODEM_TYPE_SS333)
 #ifndef MODEM_TYPE_SS333
         p.writeInt32(p_cur->isVideo);
 #endif
@@ -2426,7 +2428,7 @@ static int responseCallList(Parcel &p, void *response, size_t responselen) {
             p_cur->als,
             (p_cur->isVoice)?"voc":"nonvoc",
             (p_cur->isVoicePrivacy)?"evp":"noevp");
-#if defined(MODEM_TYPE_XMM7260) || defined(MODEM_TYPE_M7450) || defined(MODEM_TYPE_SS333)
+#if defined(MODEM_TYPE_XMM7260) || defined(MODEM_TYPE_M7450) || defined(MODEM_TYPE_SS222) || defined(MODEM_TYPE_SS333)
         appendPrintBuf("%s,%s,",
             printBuf,
             (p_cur->isVideo) ? "vid" : "novid");
@@ -3030,7 +3032,7 @@ static int responseRilSignalStrength(Parcel &p,
         p.writeInt32(p_cur->GW_SignalStrength.bitErrorRate);
 
 #if defined(MODEM_TYPE_XMM6262) || defined(MODEM_TYPE_XMM7260) \
- || defined(MODEM_TYPE_M7450) || defined(MODEM_TYPE_SS333)
+ || defined(MODEM_TYPE_M7450) || defined(MODEM_TYPE_SS222) || defined(MODEM_TYPE_SS333)
         cdmaDbm = p_cur->CDMA_SignalStrength.dbm & 0xFF;
         if (cdmaDbm < 0) {
             cdmaDbm = 99;
@@ -3044,7 +3046,7 @@ static int responseRilSignalStrength(Parcel &p,
         p.writeInt32(p_cur->CDMA_SignalStrength.ecio);
 
 #if defined(MODEM_TYPE_XMM6262) || defined(MODEM_TYPE_XMM7260) \
- || defined(MODEM_TYPE_M7450) || defined(MODEM_TYPE_SS333)
+ || defined(MODEM_TYPE_M7450) || defined(MODEM_TYPE_SS222) || defined(MODEM_TYPE_SS333)
         evdoDbm = p_cur->EVDO_SignalStrength.dbm & 0xFF;
         if (evdoDbm < 0) {
             evdoDbm = 99;
@@ -5043,6 +5045,14 @@ void RIL_onUnsolicitedResponse(int unsolResponse, const void *data,
                                             &TIMEVAL_WAKE_TIMEOUT);
     }
 
+    if (unsolResponse == RIL_UNSOL_AM) {
+        // "start -a android.intent.action.MAIN -n com.sec.app.RilErrorNotifier/.PhoneCrashNotifier --es title cpcrash"
+        if (strstr((const char*)data, "cpcrash")) {
+            RLOGE("CP crash detected");
+            s_cpCrashed = 1;
+        }
+    }
+
     // Normal exit
     return;
 
@@ -5052,6 +5062,14 @@ error_exit:
     }
 }
 
+extern "C"
+int RIL_getCpCrashed()
+{
+    int result = s_cpCrashed;
+    s_cpCrashed = 0;
+    return result;
+}
+
 /** FIXME generalize this if you track UserCAllbackInfo, clear it
     when the callback occurs
 */
diff --git a/ril/libsecril-client/Android.mk b/ril/libsecril-client/Android.mk
index 71cdc60..c598eff 100755
--- a/ril/libsecril-client/Android.mk
+++ b/ril/libsecril-client/Android.mk
@@ -18,6 +18,9 @@ LOCAL_CFLAGS :=
 ifeq ($(TARGET_BOARD_PLATFORM),exynos4)
 LOCAL_CFLAGS += -DRIL_CALL_AUDIO_PATH_EXTRAVOLUME
 endif
+ifeq ($(TARGET_SOC),exynos3470)
+LOCAL_CFLAGS += -DRIL_CALL_AUDIO_PATH_EXTRAVOLUME
+endif
 
 LOCAL_MODULE:= libsecril-client
 LOCAL_PRELINK_MODULE := false
-- 
1.9.1

